{% extends '../base.html' %}
{% load static form_tags %}

{% block extra_header %}
{% include '../includes/datatable.html' %}    
{% endblock extra_header %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/table_setup.css' %}">
{% endblock css %}
    
{% block page_title %}Inventory Count{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
    <li class="breadcrumb-item"><a href="{% url 'inventory_count' %}">Inventory Count</a></li>
    <li class="breadcrumb-item"><a href="{% url 'inventory_count_view' report.id %}">Detail</a></li>
    <li class="breadcrumb-item active">{{ location|title }} - Cycle {{ cycle_count }}</li>
{% endblock breadcrumb %}

{% block main_content %}
<div class="card m-4">
    <div class="card-header">
        <p><span class="text-muted">Description:</span> {{ report.description }}</p>
        <div class="row">
            <div class="col-6">
                <div><span class="text-muted">Inventory Date:</span> {{ report.inventory_date }}</div>
                <div><span class="text-muted">Overall Status:</span> {{ report.overall_status }}</div>
            </div>
            <div class="col-6">
                <div><span class="text-muted">Generated By:</span> {{ report.generated_by }}</div>
                <div><span class="text-muted">Created At:</span> {{ report.created_at }}</div>
            </div>
        </div>
        <div class="text-right">
            <a href="{% url 'inventory_count_view' report.id %}" class="btn btn-default">Back to Inventory Count Detail</a>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>{{ location|title }} - Cycle # {{ cycle_count }}</h4>
            </div>
        </div>
        {% if data %}
        <!-- uploaded; display data -->
        <div class="row">
            <div class="card col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h5 class="card-header">Summary</h5>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                            <div class="card">
                                <div class="card-body">
                                    <h4>{{ data.count }}</h4>
                                    <p>Product Count</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                            <div class="card">
                                <div class="card-body">
                                    <h4>{{ data.shortages }}</h4>
                                    <p>Shortages</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                            <div class="card">
                                <div class="card-body">
                                    <h4>{{ data.overages }}</h4>
                                    <p>Overages</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                            <div class="card">
                                <div class="card-body">
                                    <h4>{{ data.variance }}</h4>
                                    <p>Total Variance</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if is_open %}
                <div class="card-footer">
                    {% if cycle_count < 3 %}
                    <p>If this count is correct, click the button below to accept the count. The system will then update the inventory levels.</p>
                    <p>Otherwise, you may <a href="{% url 'inventory_count_view' report.id %}">start the next cycle</a>.</p>
                    {% else %}
                    <p>This count is complete. Please click the button below to update the inventory levels.</p>
                    {% endif %}
                    <form method="post" action="{% url 'accept_inventory_count' pk=report.id location=location cycle=cycle_count %}">
                        {% csrf_token %}
                        <button class="btn btn-primary">Accept Count</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="row mt-4 table-responsive">
            <table id="dtReport" class="table table-hover table-head-fixed table-sm">
                <thead>
                    <tr>
                        <th class="text-center">Barcode</th>
                        <th class="text-center">Product</th>
                        <th class="text-center">Expected Count</th>
                        <th class="text-center">Physical Count</th>
                        <th class="text-center">Variance</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        {% else %}
        <!-- not uploaded; display download button and upload form -->
        <div class="row mt-2">
            {% if location == "store" %}
            <a href="{% url 'inventory_count_form_store' %}?cycle={{ cycle_count }}&report={{ report.id }}" class="btn btn-info"><i class="fa fa-download"></i> Download Inventory Form</a>
            {% else %}
            <a href="{% url 'inventory_count_form_warehouse' %}?cycle={{ cycle_count }}&report={{ report.id }}" class="btn btn-info"><i class="fa fa-download"></i> Download Inventory Form</a>
            {% endif %}
        </div>
        <div class="row mt-4">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <p>Count ready? Upload the file here.</p>
                <form method="post" enctype="multipart/form-data" action="{% url 'upload_inventory_count' pk=report.id location=location cycle=cycle_count %}">
                    {% csrf_token %}
                    <input type="file" name="file" required>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock main_content %}


{% block js %}
    <script>
        $(document).ready(function() {
            $("#menu_trans").addClass("menu-open")
            $("#menu_inv_count").addClass("active")

            $('#dtReport').DataTable({
                processing: true,
                serverSide: true,
                sAjaxSource: "{% url 'inventory_count_cycle_dt' report.id %}?location={{ location }}&cycle_count={{ cycle_count }}",
                columns: [
                    { data: 1, name: 'barcode' },
                    { data: 2, name: 'full_description' },
                    { data: 3, name: 'expected_count' },
                    { data: 4, name: 'physical_count' },
                    { data: 5, name: 'variance' },
                ],
                buttons: [
                    'csv'
                ],
                order: [[2, 'asc']],
            });
        })
    </script>
{% endblock js %}
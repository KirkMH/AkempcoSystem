{% extends '../base.html' %}
{% load static %}
{% load humanize %}
{% load form_tags %}
{% load crispy_forms_tags %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/table_setup.css' %}">    
  <link rel="stylesheet" href="{% static 'css/asterisk_on_required.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css"> 
{% endblock css %}

{% block page_title %}
{% if rv.is_processed %}Manage{% else %}Create{% endif %} Requisition Voucher
{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
    <li class="breadcrumb-item"><a href="{% url 'stock_list' %}">Stock Management</a></li>
    <li class="breadcrumb-item"><a href="{% url 'rv_list' %}">Requisition Vouchers</a></li>
    <li class="breadcrumb-item active">{% if rv.is_processed %}Manage{% else %}Create{% endif %}</li>
{% endblock breadcrumb %}

{% block main_content %}

<div class="modal fade" tabindex="-1" role="dialog" id="modal">
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <input type="hidden" name="rv_pk" id="rv_pk" value="{{ rv.pk }}">
        </div>
        <div class="modal-content"></div>
    </div>
</div>

<form id="submit_rv_form" method="POST">
{% csrf_token %}
<div class="card m-4">
    <div class="card-header">
        <!-- info row -->
        <div class="row invoice-info">
            <div class="col-lg-1 invoice-col">RV #:</div>
            <div class="col-lg-5 invoice-col font-weight-bold">
                {{ rv.pk|seq_num }}
            </div>
            <div class="col-lg-1 invoice-col">RV Date:</div>
            <div class="col-lg-5 invoice-col font-weight-bold">{{ rv.requested_at|date:'F d, Y' }}</div>
        </div>
        <div class="row invoice-info">
            <div class="col-lg-1 invoice-col">Status:</div>
            <div class="col-lg-5 invoice-col font-weight-bold">{{ rv.get_status }}</div>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-4">
                {% if rv.process_step < 3 and user.userdetail.userType == 'Warehouse Staff' %}
                    <button id="add-item" class="btn btn-primary" type="button" name="add-item">Add Item</button>
                {% endif %}
            </div>
            <div class="col-8">
                <span class="float-right">
                    {% if rv.is_approved and user.userdetail.userType == 'Warehouse Staff' %}
                    <button type="button" class="btn btn-dark mb-2" id="release_inv" name="release_inv">Release Inventory</button>
                    {% elif rv.is_released and user.userdetail.userType == 'Storekeeper' %}
                    <button type="button" class="btn btn-dark mb-2" id="receive_inv" name="receive_inv">Receive Inventory</button>
                    {% endif %}
                    <a href="#" class="btn btn-dark mb-2" role="button">Print RV</a>
                </span>
            </div>
        </div>
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    {% if not rv.is_processed and user.userdetail.userType == 'Warehouse Staff' %}
                    <th>Action</th>
                    {% endif %}
                    <th width="15%">Barcode</th>
                    <th width="30%">Description</th>
                    <th class="text-center">Requested Qty</th>
                    <th class="text-center">Released Qty</th>
                    <th class="text-center">Received Qty</th>
                    <th width="10%">Units</th>
                </tr>
            </thead>
            <tbody>
                
            {% if not products %}
                <tr><td colspan="7" style="text-align: center;">No products requested yet.</td></tr>
            {% else %}
                {% for item in products %}
                    <tr>
                        {% if not rv.is_processed and user.userdetail.userType == 'Warehouse Staff' %}
                        <td class="text-center">
                            <a href="#" class="update-item" data-form-url="#">
                                <i class="far fa-edit"></i>
                            </a> | 
                            <a href="#" class="delete-item" data-product-name="{{ item.product.full_description }}" data-form-url="#">
                                <i class="far fa-trash-alt"></i>
                            </a>
                        </td>
                        {% endif %}
                        <td>{{ item.product.barcode }}</td>
                        <td>{{ item.product.full_description }}</td>
                        <td class="text-center">{{ item.requested_qty }}</td>
                        <td class="text-center">{% if rv.received_qty > 0 %}{{ item.received_qty }}{% endif %}</td>
                        <td class="text-center">{% if rv.released_qty > 0 %}{{ item.released_qty }}{% endif %}</td>
                        <td>{{ item.product.uom }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
                    
            </tbody>
        </table>


    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col-12">
                {% if user.userdetail.userType == 'Warehouse Staff' and rv.process_step < 3 %}
                
                    {% if products %}
                    <button type="button" name="submit_btn" id="submit_btn" class="btn btn-warning card-link">Submit</button>
                    {% endif %}
                    
                    <button type="button" id="cancel" class="btn btn-danger card-link">Cancel</button>
                {% elif user.userdetail.userType == rv.get_user_type and user.userdetail.userType != 'Officer-In-Charge' or user.userdetail.userType == 'Officer-In-Charge' and user.userdetail.oic_for == rv.category %}
                    <input type="hidden" name="reject_reason" id="reject_reason" >
                    <button type="button" name="approve_btn" id="approve_btn" class="btn btn-warning card-link">Approve</button>
                    <button type="button" name="reject_btn" id="reject_btn" class="btn btn-danger card-link">Reject</button>
                {% endif %}
                <a href="{% url 'rv_list' %}" class="btn btn-default card-link float-right">Back to list</a>
            </div>
        </div>
    </div>
</div>
</form>

<form id="delete_form" method="POST">
    {% csrf_token %}
</form>

{% endblock main_content %}

{% block js %}
  <script src="{% static 'js/jquery.bootstrap.modal.forms.min.js' %}"></script>
  <!-- bootboxjs -->
  <script src="{% static 'js/bootbox.all.min.js' %}"></script>


  <script type="text/javascript">
    $(document).ready(function() {
    
        $("#add-item").modalForm({
            formURL: "{% url 'rv_products_add' rv.pk %}"
        });
        
        function updateItemModalForm() {
          $(".update-item").each(function () {
            $(this).modalForm({
              formURL: $(this).data("form-url")
            });
          });
        }
        updateItemModalForm();
        
        function deleteItemModalForm() {
          $(".delete-item").each(function () {
            $(this).click(function() {
                var url = $(this).data("form-url");
                var product = $(this).data("product-name");
                bootbox.confirm("Are you sure you want to remove " + product + "?", function(result){ 
                    if (result) {
                        // location.href = url;
                        $('#delete_form').attr('action', url);
                        $('#delete_form').submit()
                    }
                });
            });
          });
        }
        deleteItemModalForm();

        $('#submit_btn').click(function() {
            bootbox.confirm("Are you sure you want to submit this requisition voucher for approval?", function(result){ 
                if (result) {
                    $('#submit_rv_form').attr('action', "#");
                    $('#submit_rv_form').submit();
                }
            });
        })

        $('#cancel').click(function() {
            bootbox.confirm("Are you sure you want to cancel this transaction? All added information and products will be removed.", function(result){ 
                if (result) {
                    $('#delete_form').attr('action', "#");
                    $('#delete_form').submit();
                }
            });
        })

        $('#approve_btn').click(function() {
            bootbox.confirm("Are you sure you want to approve this requisition voucher?", function(result){ 
                if (result) {
                    $('#submit_rv_form').attr('action', "#");
                    $('#submit_rv_form').submit();
                }
            });
        })

        $('#reject_btn').click(function() {
            bootbox.confirm("Are you sure you want to reject this requisition voucher?", function(result){ 
                if (result) {
                    bootbox.prompt("Please enter the reason for rejecting this requisition voucher.", function(result){ 
                        if (result != null) {
                            $('#reject_reason').val(result);
                            $('#submit_rv_form').attr('action', "#");
                            $('#submit_rv_form').submit();
                        }
                    });
                }
            });
        })

        $('#receive_inv').click(function() {
            bootbox.prompt({
                title: "Reference Number:",
                'value': "{{ rv.reference_number }}",
                callback: function (result) {
                    if (result != null)
                        $.ajax({
                            url: "#",
                            type: 'POST',
                            data: {
                                'csrfmiddlewaretoken': "{{ csrf_token }}",
                                'value': result, 
                            },
                            dataType: 'json',
                            success: function(data) {
                                location.href = data;
                            }
                        })
                }
            });
        })
    
    });
  </script>

{% endblock js %}
    